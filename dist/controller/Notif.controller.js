sap.ui.define(["../controller/App.controller","sap/m/MessageBox","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/core/BusyIndicator","sap/m/ColumnListItem","sap/m/Label","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/table/Column","sap/m/Column","sap/m/Text","sap/ui/core/library","sap/m/MessageItem","sap/m/MessageView","sap/m/Button","sap/m/Dialog","sap/m/Bar","sap/m/Title","sap/ui/core/IconPool","sap/ui/core/Core","sap/m/library","sap/m/MessageToast","sap/m/TextArea","sap/ushell/Container","sap/ui/core/format/DateFormat","sap/ui/core/Fragment","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/comp/filterbar/FilterBar","sap/ui/comp/filterbar/FilterGroupItem","sap/m/Input","sap/m/List","sap/m/VBox","sap/m/Popover"],function(e,t,r,i,s,o,n,a,l,g,u,d,p,h,c,m,f,w,S,M,y,A,V,P,T,C,v,x,F,H,_,I,R,E){"use strict";var b=p.TitleLevel,N=A.ButtonType,Q=A.DialogType,B=p.ValueState,D={};var L,U,k,G,O;return e.extend("com.karsan.qm.sapmaportali.controller.Notif",{formatter:i,onInit(){D=this.getOwnerComponent().getModel();D.setSizeLimit(1e6);this.getRouter().getRoute("Notif").attachMatched(this._onRouteMatched,this)},_onRouteMatched(e){this.getOwnerComponent().getModel().metadataLoaded().then(async()=>{try{await this._getUserInformation();this._setInitModel();let t=e.getParameter("arguments").Qmnum;this._loadNotif(t)}catch(e){return this._rejectInvalidUserAccess()}})},async _loadNotif(e){try{s.show();let t=T.getUser().getId().toUpperCase();const r=D.createKey("/UserSet",{Uname:t});const i=await this.onRead(r,D);this.getViewModel().setProperty("/LoggedUser",i);let o=D.createKey("/HeaderSet",{Qmnum:e});const n={$expand:"Flow,Vehicle,Comment,CurrentApr"};const a=await this.onReadExpanded(o,[],n,D);let l=await this._checkNotifAuth(a.Qmnum);if(l){this.setNotifDataToView(a)}}catch(e){}finally{s.hide()}},async _checkNotifAuth(e){if(e==="INVALID"||e.includes("UNAUTH")){s.hide();t.error(this.getText(e+"SPM"),{actions:[t.Action.CLOSE],onClose:function(){this.onNavToReport()}.bind(this)})}else{return true}},async setNotifDataToView(e){this.getViewModel().setProperty("/Header",e);this.getViewModel().setProperty("/PrevRefQmnum",e.RefQmnum);this.onRefreshAtta();this.getViewModel().setProperty("/Vehicle",e.Vehicle.results);this.getViewModel().setProperty("/Comment",e.Comment.results);this.getViewModel().setProperty("/Flow",e.Flow.results);this.getViewModel().setProperty("/FlowGenerated",e.Flow.results.length>0);this._setFlowToView(e.Flow.results);let t=this.getViewModel().getProperty("/LoggedUser");this.getViewModel().setProperty("/CurrentApr",e.CurrentApr.results);let r=e.CurrentApr.results.some(e=>e.Aprgr==="ÃœRTMKAL");let i=e.CurrentApr.results.some(e=>e.Aprvr===t.Uname);let o=e.CurrentApr.results.filter(e=>e.Aprst==="03");let n=o.length>0?o[0].Aprgr:"";let a=e.Statu==="";let l=!(e.Statu==="E0002"&&t.IsSupplier)&&((e.Statu===""||e.Statu==="E0001"||e.Statu==="E0002")&&(e.Ernam===t.Uname||t.AuthAdmin))||e.Statu==="E0002"&&!t.IsSupplier;let g=e.Statu==="E0002";let u=e.Statu==="E0003";let d=e.Statu==="E0004";let p=e.Statu==="E0004"||e.Statu==="E0005"||e.Statu==="E0006";this.getViewModel().setProperty("/Editable",l);this.getViewModel().setProperty("/ReqKarsan",g);this.getViewModel().setProperty("/InAprProccess",u);this.getViewModel().setProperty("/IsCancelled",d);this.getViewModel().setProperty("/IsCompleted",p);this.getViewModel().setProperty("/IsSupplierLogged",t.IsSupplier);this.getViewModel().setProperty("/isAprLogged",i||t.AuthAdmin);this.getViewModel().setProperty("/CurrentAprgr",n);this.getViewModel().setProperty("/isAprUrtmKltLogged",r);this.getViewModel().setProperty("/TabAuth",{General:true,Vehicle:!t.IsSupplier&&(l||u||p),Flow:!t.IsSupplier&&(l||u||p),Attachment:true,Comment:true});this.getViewModel().setProperty("/ActionVis",{CancelNotif:!t.IsSupplier&&(e.Ernam===t.Uname||t.AuthAdmin),SaveNotif:!p&&(l||t.AuthAdmin),SendToKarsan:!p&&l&&t.IsSupplier,SendForApproval:!p&&!u&&!t.IsSupplier&&(e.Ernam===t.Uname||t.AuthAdmin),CancelAndCopy:!a&&!t.IsSupplier&&(e.Ernam===t.Uname||t.AuthAdmin)});this.getViewModel().setProperty("/VisDetail",true);s.hide()},onChangeRefQmnum(e){let r=this;let i="";let s=this.getViewModel().getProperty("/PrevRefQmnum");if(e.hasOwnProperty("mParameters")){i=e?.getParameter("value")}else{i=e}this.confirmAction(r.getText("ConfirmGetRefQmnum"),this.getView()).then(async function(e){if(e.confirmed){try{const e=D.createKey("/ShRefQmnumSet",{Qmnum:i});let t=await r.onRead(e,D);r.getViewModel().setProperty("/PrevRefQmnum",t.Qmnum);r._loadNotif(i)}catch(e){r.getViewModel().setProperty("/Header/RefQmnum",s);return t.error(r.getText("ErrNotFoundRefQmnum"))}}else{r.getViewModel().setProperty("/Header/RefQmnum",s);V.show(r.getText("MsgCancelled"))}})},async onGenerateFlow(){let e=this;let r=this.getViewModel().getProperty("/Header");if(!r.Kaynak||!r.PartStatu||!r.HataTuru){return t.error(this.getText("MsgFlowNotGenerated"))}try{s.show();let t=await e.onCreate("/HeaderSet",e._buildReqHeaderCreate("GenFlow"),D);const r=t.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!r){e.getViewModel().setProperty("/Flow",t.Flow.results);e.getViewModel().setProperty("/FlowGenerated",true);e._setFlowToView(t.Flow.results)}e._showMessage(t.Return.results)}catch(t){e.handleServiceResponse()}finally{s.hide()}},onDeleteFlow(e){let t=this;this.confirmAction(t.getText("ConfirmClearFlow"),this.getView()).then(async function(e){if(e.confirmed){t.getViewModel().setProperty("/FlowView",[]);t.getViewModel().setProperty("/Flow",[]);t.getViewModel().setProperty("/FlowGenerated",false)}else{V.show(t.getText("MsgCancelled"))}})},async onAddApprover(){let e={};let r=this.byId("IdflowTable");let i=r.getSelectedItem();if(!i){return t.error(this.getText("ErrSelectFlowGroup"))}else{e=i.getBindingContext("viewModel").getObject()}let s=await this.onOpenApproverList(e.Aprgr);if(s.length>0){let t=this.getViewModel().getProperty("/Flow");let r=t.filter(t=>t.Aprgr===e.Aprgr);let i=r[0];let o=Math.max(...t.filter(t=>t.Aprgr===e.Aprgr).map(e=>parseInt(e.Posnr,10)),0)+1;s.forEach(e=>{let r=t.some(t=>t.Aprgr===i.Aprgr&&t.Aprvr===e.Aprvr);if(r){return}t.push({Qmnum:this.getViewModel().getProperty("/Header/Qmnum"),Aprgr:i.Aprgr,Agrtx:i.Agrtx,Posnr:o,Aprvr:e.Aprvr,AprvrFullname:e.AprvrFullname,Aprst:"01",AprstTxt:this.getText("AprstTxt01")});o++});this.getViewModel().setProperty("/Flow",t);this._setFlowToView(t)}else{V.show(this.getText("MsgNoApproverSelected"))}},onOpenApproverList(e){const t=this;return new Promise(function(r){const i=new _({id:"IdAprvrSearch",placeholder:t.getText("Search"),liveChange:function(e){let t=e.getParameter("value");let r=e.getSource().getParent().getAggregation("items")[1];let i=r.getItems();i.forEach(e=>{let r=e.getBindingContext()?.getProperty("Aprvr")||"";let i=!t||r.toUpperCase().includes(t.toUpperCase());e.setVisible(i)})}});const s=new I({id:"IdAprvrList",mode:"MultiSelect",items:{path:"/ShAprvrSet",filters:[new a("Aprgr",l.EQ,e)],template:new sap.m.StandardListItem({title:"{AprvrFullname}",description:"{Aprvr}",selected:false})}});s.addStyleClass("sapUiTinyMarginBeginEnd sapUiTinyMarginTopBottom");const o=new f({title:t.getText("SelectApprover"),content:[new R({items:[i,s],spacing:"0.5rem"})],beginButton:new m({text:t.getText("Complete"),type:N.Emphasized,press:function(){let e=s.getSelectedItems();let t=[];e.forEach(e=>{let r=e.getBindingContext().getObject();t.push({Posnr:"",Aprvr:r.Aprvr,AprvrFullname:r.AprvrFullname})});r(t);o.close()}}),endButton:new m({text:t.getText("Cancel"),type:N.Default,press:function(){r([]);o.close()}}),afterClose:function(){o.destroy()}});t.getView().addDependent(o);o.open()})},_setFlowToView(e){let t=[];e.forEach(e=>{let r=t.find(t=>t.Aprgr===e.Aprgr);if(!r){r={Aprgr:e.Aprgr,Agrtx:e.Agrtx,Aprst:e.Aprst,AprstTxt:e.AprstTxt,Descr:e.Descr,Trapr:e.Trapr,Trdat:e.Trdat,Aprdt:e.Aprdt,Item:[]};t.push(r)}if(e.Aprvr!==""){const t=r.Item.some(t=>t.Aprvr===e.Aprvr);if(!t){r.Item.push({Posnr:e.Posnr,Aprvr:e.Aprvr,AprvrFullname:e.AprvrFullname})}}});let r=t.some(e=>e.Aprgr==="MGD"&&e.Item.length>0);this.getViewModel().setProperty("/isMgdInFlow",r);this.getViewModel().setProperty("/FlowView",t)},_setFlowFromView(){let e=this.getViewModel().getProperty("/Header/Qmnum");let t=this.getViewModel().getProperty("/FlowView");let r=[];let i={};if(Array.isArray(t)){t.forEach(t=>{if(!i[t.Aprgr]){i[t.Aprgr]=1}t.Item.forEach(s=>{const o=r.some(e=>e.Aprgr===t.Aprgr&&e.Aprvr===s.Aprvr);if(!o){r.push({Qmnum:e,Aprgr:t.Aprgr,Agrtx:t.Agrtx,Posnr:String(i[t.Aprgr]++),Aprvr:s.Aprvr,AprvrFullname:s.AprvrFullname,Aprst:t.Aprst,AprstTxt:t.AprstTxt,Descr:t.Descr,Trapr:t.Trapr,Trdat:t.Trdat,Aprdt:t.Aprdt})}})})}this.getViewModel().setProperty("/Flow",r);return r},onRemoveAprvr(e){let t=this.getViewModel().getProperty("/Flow");let r=e.getSource().getParent().getParent().getParent().getParent().getBindingContext("viewModel").getObject().Aprgr;let i=e.getSource().getParent().getBindingContext("viewModel").getObject().Posnr;let s=t.findIndex(e=>e.Aprgr===r&&e.Posnr===i);if(s===-1){return}let o=t.filter(e=>e.Aprgr===r&&e.Posnr!==i);if(o.length>0){t=t.filter(e=>!(e.Aprgr===r&&e.Posnr===i))}else{let e=t[s];e.Aprvr="";e.AprvrFullname="";e.Aprst="";e.AprstTxt="";e.Descr="";e.Trapr="";e.Trdat=null;e.Aprdt=null}let n=1;t.forEach(e=>{if(e.Aprgr===r&&e.Aprvr!==""){e.Posnr=String(n++)}});this.getViewModel().setProperty("/Flow",t);this._setFlowToView(t)},onPrevMultiAddVehicle(e){const r=this.getViewModel().getProperty("/Header")||{};if(!r.UrunGrubu){return t.error(this.getText("NeedUrunGrubu"))}this.byId("IdVIntervalBox").setVisible(!this.byId("IdVIntervalBox").getVisible())},onCloseMultiAddVehicle(){this.byId("IdVIntervalBox").setVisible(false)},onMultiAddVehicle(){var e=this;let r=this.getViewModel().getProperty("/Header")||{};let i=this.getViewModel().getProperty("/VehicleStartSasi");let o=this.getViewModel().getProperty("/VehicleEndSasi");if(!i||!o){return t.error(this.getText("ErrVehicleInterval"))}s.show();let n=[new a("SasiNo",l.BT,i,o),new a("UrunGrubu",l.EQ,r.UrunGrubu)];D.read("/ShSasiSet",{filters:n,success:r=>{if(r.results.length>0){this.getViewModel().setProperty("/VehicleStartSasi","");this.getViewModel().setProperty("/VehicleEndSasi","");let e=this.getViewModel().getProperty("/Vehicle");r.results.forEach(t=>{e.push({SasiNo:t.SasiNo})});this.getViewModel().setProperty("/Vehicle",e);this._formatVehicleTable();this.onCloseMultiAddVehicle();s.hide()}else{s.hide();return t.error(e.getText("ErrNotFoundInterval"))}},error:e=>{let t=[];let r=this.getView().getModel().getMessagesByPath("");let i=this.getView().getModel().getMessagesByEntity("/ShSasiSet");t=[...r,...i];s.hide();this._showMessage(this._formatMessage(t,"FrontSide"))}})},onAddVehicle(){const e=this.getViewModel().getProperty("/Header")||{};if(!e.UrunGrubu){return t.error(this.getText("NeedUrunGrubu"))}let r=this.getViewModel().getProperty("/Vehicle");r.push({SasiNo:""});this.getViewModel().setProperty("/Vehicle",r);this._formatVehicleTable()},onRemoveVehicle(e){let t=[];let r=this.byId("IdTableVehicle").getSelectedItems();this.byId("IdTableVehicle").removeSelections();r.forEach(e=>{let r=e.getBindingContext("viewModel").getObject();t.push({SasiNo:r.SasiNo})});let i=this.getViewModel().getProperty("/Vehicle");let s=new Set(t.map(e=>e.SasiNo));let o=i.filter(e=>!s.has(e.SasiNo));this.getViewModel().setProperty("/Vehicle",o);this._formatVehicleTable()},_formatVehicleTable(){let e=this.getViewModel().getProperty("/Vehicle");e.sort((e,t)=>e.SasiNo.localeCompare(t.SasiNo));let t=new Set;let r=true;let i=e.filter(e=>{const i=e.SasiNo.trim();e.SasiNo=i;if(!i){if(r){r=false;return true}return false}if(t.has(i)){return false}t.add(i);return true});this.getViewModel().setProperty("/Vehicle",i)},async uploadFiles(e){const t=this.byId("IdAttaUploader");const r=t.getIncompleteItems();const i=r.length;const s=this.getUploadUrl(e);if(i){r.forEach(e=>{e.setUploadUrl(s)});await t.upload()}},getUploadUrl(e){const t=this.getModel();const r=this.getViewModel();const i=r.getProperty("/Header/Qmnum")||{};const s=t.createKey("/HeaderSet",{Qmnum:e||i});const o=t.sServiceUrl;return`${o}${s}/Attachment`},onBeforeAttUpload(e){const t=this.getModel();const r=e.getParameter("item");t.refreshSecurityToken();r.removeAllHeaderFields();r.addHeaderField(new sap.ui.core.Item({key:"x-csrf-token",text:t.getSecurityToken()}));r.addHeaderField(new sap.ui.core.Item({key:"slug",text:encodeURIComponent(r.getFileName())}))},async onComplAttUpload(e){const t=e.getParameter("item");if(t?.getUploadState()==="Complete"){this.byId("IdAttaUploader").removeItem(t);await this.onRefreshAtta()}},async onRemoveAttItem(e){const t=this.getViewModel();const r=e.getParameter("item")?.getBindingContext("viewModel")?.getPath();const i=t.getProperty("/Attachment")||[];const o=t.getProperty(r);if(o){const e=this.getModel();const n=e.createKey("/AttachmentSet",{Qmnum:o.Qmnum,RecGuid:o.RecGuid,AppType:o.AppType,ObjKey:o.ObjKey});const a=+r.split("/").pop();s.show();try{await this.onDelete(n,e);i.splice(a,1);t.setProperty("/Attachment",i);s.hide();V.show(this.getText("successDeleteAtta"))}catch(e){s.hide()}}},onOpenAttItem:function(e){const t=e.getSource().getParent();const r=this.getViewModel();const i=t.getBindingContext("viewModel").getPath();const s=r.getProperty(i);if(s){window.open(s.Url,"_blank")}},onRefreshAtta:async function(){let e=this.getViewModel().getProperty("/Header/Qmnum")||"";s.show();let t=await this.onReadQuery("/AttachmentSet",[new a("Qmnum",l.EQ,e)],D);this.getViewModel().setProperty("/Attachment",t.results||[]);s.hide()},onPostComment(e){const r=this.getViewModel().getProperty("/Header")||{};const i=e.getParameter("value");if(!i){return t.error(this.getText("NoCommentProvided"))}const s=this.getViewModel().getProperty("/Comment");const o=s.length>0?Math.max(...s.map(e=>e.Posnr))+1:1;s.push({Qmnum:r?.Qmnum||"",Posnr:String(o),Descr:i,Erdat:new Date,Erzet:this.getCurrentTimeEdmFormat(),Ernam:r?.Ernam||"",ErnamFullname:r?.ErnamFullname||""});s.sort((e,t)=>e.Posnr-t.Posnr);s.forEach((e,t)=>{e.Posnr=String(t+1)});this.getViewModel().setProperty("/Comment",s)},onEditComment(e){let t=e.getSource().getParent().getBindingContext("viewModel").getPath().slice(9);let r=this.getViewModel().getProperty("/Comment");this.byId("IdCommentInput").setValue(r[t].Descr);r.splice(t,1);r.forEach((e,t)=>{e.Posnr=String(t+1)});this.getViewModel().setProperty("/Comment",r)},onRemoveComment(e){let t=e.getSource().getParent().getBindingContext("viewModel").getPath().slice(9);let r=this.getViewModel().getProperty("/Comment");r.splice(t,1);r.forEach((e,t)=>{e.Posnr=String(t+1)});this.getViewModel().setProperty("/Comment",r)},onSaveNotif(){let e=this;this.confirmAction(e.getText("ConfirmSaveNotif"),this.getView()).then(async function(t){if(t.confirmed){try{s.show();let t=e.getViewModel().getProperty("/Header");let r=t.Qmnum==="&1";let i=await e.onCreate("/HeaderSet",e._buildReqHeaderCreate("SaveNotif"),D);const o=i.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!o){await e.uploadFiles(i.Qmnum);if(r){e.getRouter().navTo("Notif",{Qmnum:i.Qmnum})}await e._loadNotif(i.Qmnum)}e._showMessage(i.Return.results)}catch(t){e.handleServiceResponse()}finally{s.hide()}}else{V.show(e.getText("MsgCancelled"))}})},onSendToKarsan(){let e=this;let t=this.getViewModel();let r=t.getProperty("/Header")||{};if(this._checkSuppNotif()==="OK"){this.confirmAction(e.getText("ConfirmSendToKarsan"),this.getView()).then(async function(t){if(t.confirmed){try{s.show();let t=r.Qmnum==="&1";let i=await e.onCreate("/HeaderSet",e._buildReqHeaderCreate("SendToKrsn"),D);const o=i.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!o){await e.uploadFiles(i.Qmnum);if(t){e.getRouter().navTo("Notif",{Qmnum:i.Qmnum})}await e._loadNotif(i.Qmnum)}e._showMessage(i.Return.results)}catch(t){e.handleServiceResponse()}finally{s.hide()}}else{V.show(e.getText("MsgCancelled"))}})}},onCancelNotif(){let e=this;let t=this.getViewModel();let r=t.getProperty("/Header")||{};this.confirmAction(e.getText("ConfirmCancelNotif"),this.getView(),3).then(async function(t){if(t.confirmed){if(r.Qmnum==="&1"){return e.onNavToReport()}try{s.show();let r=e._buildReqHeaderCreate("CancelNotif");r.CancelRsn=t.description||"";let i=await e.onCreate("/HeaderSet",r,D);const o=i.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!o){await e._loadNotif(i.Qmnum)}e._showMessage(i.Return.results)}catch(t){e.handleServiceResponse()}finally{s.hide()}}else{V.show(e.getText("MsgCancelled"))}})},onCancelAndCopy(){let e=this;let t=this.getViewModel();let r=t.getProperty("/Header")||{};t.setProperty("/CopyByCancel",false);let i=new sap.m.CheckBox({text:e.getText("CopyByCancel"),selected:false,select:function(r){t.setProperty("/CopyByCancel",r.getParameter("selected"));e._sRequired=r.getParameter("selected")}});i.addStyleClass("sapUiSmallMarginTopBottom");this.confirmAction(e.getText("ConfirmCancelAndCopyNotif"),this.getView(),4,i).then(async function(r){if(r.confirmed){try{s.show();let i=t.getProperty("/CopyByCancel")?"CancelCopy":"Copy";let o=e._buildReqHeaderCreate(i);o.CancelRsn=r.description||"";let n=await e.onCreate("/HeaderSet",o,D);const a=n.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!a){e.getRouter().navTo("Notif",{Qmnum:n.Qmnum})}e._showMessage(n.Return.results)}catch(t){e.handleServiceResponse()}finally{s.hide()}}else{V.show(e.getText("MsgCancelled"))}})},onSendForApproval(){let e=this;if(this._checkNotif()==="OK"){this.confirmAction(e.getText("ConfirmSendForApproval"),this.getView()).then(async function(t){if(t.confirmed){try{s.show();let t=e.getViewModel().getProperty("/Header");let r=t.Qmnum==="&1";let i=await e.onCreate("/HeaderSet",e._buildReqHeaderCreate("SendApr"),D);const o=i.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!o){await e.uploadFiles(i.Qmnum);if(r){e.getRouter().navTo("Notif",{Qmnum:i.Qmnum})}await e._loadNotif(i.Qmnum)}e._showMessage(i.Return.results)}catch(t){e.handleServiceResponse()}finally{s.hide()}}else{V.show(e.getText("MsgCancelled"))}})}},handleServiceResponse:function(e){let t=[];let r=this.getView().getModel().getMessagesByPath("");let i=this.getView().getModel().getMessagesByEntity(e||"/HeaderSet");t=[...r,...i];this._showMessage(t)},_checkSuppNotif(){this._clearMessages();let e=this.getViewModel().getData();let t=[];const r=e.Header;const i=e=>{if(e instanceof Date){return e===null}return e===undefined||e===null||e?.trim()===""||Number(e)<=0};const s=(e,r)=>{t.push({type:"Error",title:this.getText(e),subtitle:this.getText(r),description:this.getText(e)})};["Matnr","Lifnr","Tekrar","Kaynak"].forEach(e=>{if(i(r[e])){s("ErrEnter"+e,"FundamentalTitle")}});const o=r.Rkmng>0;const n=!i(r.Begda);const a=!i(r.Endda);const l=n&&a;if(!o&&!l){s("ErrMengeOrDate","FundamentalTitle")}["SapmaTuru","SapmaDescr","SpmNrmlDrm","SpmDrm","HataTuru"].forEach(e=>{if(i(r[e])){s("ErrEnter"+e,"SapmaDetailTitle")}});["RootIssue","SapmaFix","SapmaFixDat","SapmaPrevent","SapmaPreDat"].forEach(e=>{if(i(r[e])){s("ErrEnter"+e,"SapmaAnalysisTitle")}else if(typeof r[e]==="string"&&r[e].trim().length<10){s("ErrMin10Char"+e,"SapmaAnalysisTitle")}});return t.some(e=>e.type==="Error")?this._showMessage(t):"OK"},_checkNotif(){this._clearMessages();let e=this.getViewModel().getData();let t=[];const r=e.Header;const i=e=>{if(e instanceof Date){return e===null}return e===undefined||e===null||e?.trim()===""||Number(e)<=0};const s=(e,r)=>{t.push({type:"Error",title:this.getText(e),subtitle:this.getText(r),description:this.getText(e)})};["Matnr","Lifnr","UrunGrubu","Tekrar","Kaynak"].forEach(e=>{if(i(r[e])){s("ErrEnter"+e,"FundamentalTitle")}});const o=r.Rkmng>0;const n=!i(r.Begda);const a=!i(r.Endda);const l=n&&a;if(!o&&!l){s("ErrMengeOrDate","FundamentalTitle")}["SapmaTuru","SapmaDescr","SpmNrmlDrm","SpmDrm","HataTuru","AracBolumu"].forEach(e=>{if(i(r[e])){s("ErrEnter"+e,"SapmaDetailTitle")}});["RootIssue","SapmaFix","SapmaFixDat","SapmaPrevent","SapmaPreDat"].forEach(e=>{if(i(r[e])){s("ErrEnter"+e,"SapmaAnalysisTitle")}else if(typeof r[e]==="string"&&r[e].trim().length<10){s("ErrMin10Char"+e,"SapmaAnalysisTitle")}});if(e.Flow.length<1){s("ErrGenFlow","FlowTitle")}const g=new Set(e.Flow.map(e=>e.Aprgr));g.forEach(t=>{const r=e.Flow.some(e=>e.Aprgr===t&&!i(e.Aprvr));if(!r){s("ErrAprvrForAprgr","FlowTitle")}});return t.some(e=>e.type==="Error")?this._showMessage(t):"OK"},onApprove(e){let t=this;this.confirmAction(t.getText("ConfirmApprove"),this.getView()).then(async function(e){if(e.confirmed){try{s.show();let e=await t.onCreate("/HeaderSet",t._buildReqHeaderCreate("Approve"),D);const r=e.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!r){await t.uploadFiles(e.Qmnum);await t._loadNotif(e.Qmnum)}t._showMessage(e.Return.results)}catch(e){t.handleServiceResponse()}finally{s.hide()}}else{V.show(t.getText("MsgCancelled"))}})},onReject(e){let r=this;let i=e.getSource().getParent().getParent().getParent().getBindingContext("viewModel").getObject();if(!i.Descr||i.Descr.trim()===""){return t.error(r.getText("ErrEnterRejectReason"))}this.confirmAction(r.getText("ConfirmReject"),this.getView()).then(async function(e){if(e.confirmed){try{s.show();let e=await r.onCreate("/HeaderSet",r._buildReqHeaderCreate("Reject"),D);const t=e.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!t){await r.uploadFiles(e.Qmnum);await r._loadNotif(e.Qmnum)}r._showMessage(e.Return.results)}catch(e){r.handleServiceResponse()}finally{s.hide()}}else{V.show(r.getText("MsgCancelled"))}})},onDetermineMgd(e){let t=this;this.confirmAction(t.getText("ConfirmDetermineMgd"),this.getView()).then(async function(e){if(e.confirmed){let e="MGD";let r=await t.onOpenApproverList(e);if(r.length>0){let i=t.getViewModel().getProperty("/Flow");let s=i.filter(t=>t.Aprgr===e);let o=s[0]||{Aprgr:e,Agrtx:t.getText("AprgrMGD")};let n=Math.max(...i.filter(t=>t.Aprgr===e).map(e=>parseInt(e.Posnr,10)),0)+1;r.forEach(e=>{let r=i.some(t=>t.Aprgr===o.Aprgr&&t.Aprvr===e.Aprvr);if(r){return}i.push({Qmnum:t.getViewModel().getProperty("/Header/Qmnum"),Aprgr:o.Aprgr,Agrtx:o.Agrtx,Posnr:n,Aprvr:e.Aprvr,AprvrFullname:e.AprvrFullname,Aprst:"01",AprstTxt:t.getText("AprstTxt01")});n++});t.getViewModel().setProperty("/Flow",i);t._setFlowToView(i)}else{V.show(t.getText("MsgNoApproverSelected"))}}else{V.show(t.getText("MsgCancelled"))}})},onDeleteMgd(e){let t=this;this.confirmAction(t.getText("ConfirmDeleteMgd"),this.getView()).then(function(e){if(e.confirmed){let e="MGD";let r=t.getViewModel().getProperty("/Flow");let i=r.filter(t=>t.Aprgr!==e);t.getViewModel().setProperty("/Flow",i);t._setFlowToView(i);V.show(t.getText("MsgDeleteMgdSuccess"))}else{V.show(t.getText("MsgCancelled"))}})},_buildReqHeaderCreate(e){let t=this.getViewModel().getData();t.Comment?.forEach(e=>{delete e.__metadata;delete e.ErdatFormatted;e.Qmnum=t.Header.Qmnum;e.Erdat=this._formatDate(e.Erdat)});return{Util:e,Qmnum:t.Header.Qmnum,RefQmnum:t.Header.RefQmnum,Matnr:t.Header.Matnr,Rkmng:t.Header.Rkmng,Mgein:t.Header.Mgein,Lifnr:t.Header.Lifnr,UrunGrubu:t.Header.UrunGrubu,Begda:t.Header.Begda,Endda:t.Header.Endda,Tekrar:t.Header.Tekrar,PartStatu:t.Header.PartStatu,Kaynak:t.Header.Kaynak,SapmaTuru:t.Header.SapmaTuru,SapmaDescr:t.Header.SapmaDescr,SpmNrmlDrm:t.Header.SpmNrmlDrm,SpmDrm:t.Header.SpmDrm,HataTuru:t.Header.HataTuru,AracBolumu:t.Header.AracBolumu,RootIssue:t.Header.RootIssue,SapmaFix:t.Header.SapmaFix,SapmaPrevent:t.Header.SapmaPrevent,Prueflos:t.Header.Prueflos,SapmaFixDat:t.Header.SapmaFixDat,SapmaPreDat:t.Header.SapmaPreDat,CancelRsn:t.Header.CancelRsn,Flow:this._setFlowFromView(),Vehicle:t.Vehicle,Comment:t.Comment,Return:[]}},_setInitModel(){this.getViewModel().setProperty("/VisDetail",false);this.getViewModel().setProperty("/Header",{});this.getViewModel().setProperty("/Flow",[]);this.getViewModel().setProperty("/FlowView",[]);this.getViewModel().setProperty("/Vehicle",[]);this.getViewModel().setProperty("/Comment",[]);this.getViewModel().setProperty("/FlowGenerated",false);this.getViewModel().setProperty("/Editable",false)},_formatDate:function(e){if(e instanceof Date){var t=e.getTimezoneOffset();e.setMinutes(e.getMinutes()-t)}return e},_removeSpaces(e){if(typeof e==="string"){return e.replace(/^\s+/,"")}return e},_formatQuantity(e){var t=parseFloat(e);if(isNaN(t)){return}return t.toLocaleString("en-US",{useGrouping:false,minimumFractionDigits:3,maximumFractionDigits:3})},onNavToReport(){this.getViewModel().setProperty("/DetailVis",false);this.getRouter().navTo("Report")},onInfoPress(e,t){let r=this.getText("Info"+e);let i=new d({text:r});i.addStyleClass("sapUiSmallMargin");this._oInfoPopover=new E({content:i,showHeader:false});this.getView().addDependent(this._oInfoPopover);this._oInfoPopover.openBy(t.getSource())},onChangeCombobox:function(e){var t=e.getSource(),r=t.getSelectedKey(),i=t.getValue();if(!r&&i){t.setValueState(B.Error);t.setValueStateText(this.getText("Invalid"))}else{t.setValueState(B.None)}},onChangeCharInput(e){var t="",r="",i=this._removeSpaces(e.getParameter("value"));if(e.getSource().getBinding("value").getContext()){t=e.getSource().getBinding("value").getContext().sPath+"/"}var s=e.getSource().getBinding("value").sPath;if(!t){r=t+s}this.getViewModel().setProperty(r,i)},onChangeQuanInput(e){var t="",r="",i=this._formatQuantity(e.getParameter("value"));if(e.getSource().getBinding("value").getContext()){t=e.getSource().getBinding("value").getContext().sPath+"/"}var s=e.getSource().getBinding("value").sPath;if(!t){r=t+s}this.getViewModel().setProperty(r,i)},onChangeInputSasi(e){this._formatVehicleTable()},onChangeInputLifnr(e){this.onChangeCharInput(e);let r=this.getViewModel().getProperty("/Header/Lifnr");if(!r){this.getViewModel().setProperty("/Header/LfName1","")}else{let e=this.getViewModel().getProperty("/Header/Matnr");if(!e){this.getViewModel().setProperty("/Header/Lifnr","");this.getViewModel().setProperty("/Header/LfName1","");return t.error(this.getText("EnterFirstMatnr"))}}},onChangeInputMatnr(e){this.onChangeCharInput(e);let t=this.getViewModel().getProperty("/Header/Matnr");if(!t){this.getViewModel().setProperty("/Header/Maktx","");this.getViewModel().setProperty("/Header/Mgein","");this.getViewModel().setProperty("/Header/Lifnr","");this.getViewModel().setProperty("/Header/LfName1","")}},onChangeInputRkmng(e){this.onChangeQuanInput(e)},onSuggestRefQmnum(e){const t=e.getParameter("suggestValue");const r=e.getSource();const i=r.getBinding("suggestionItems");if(t.length>=3){const e=new a("Qmnum",l.Contains,t);i.filter([e])}else{i.filter([])}},onVhRefQmnum:function(e){let t=this;const r=e.getSource();const i=this.getView();const s=i.getModel();this._SHRefQmnum=new x({title:this.getText("ShRefQmnumTitle"),supportMultiselect:false,resizable:true,key:"Qmnum",ok:e=>{let i=e.getParameter("tokens");let s=i[0].getKey();r.setValue(s);this._SHRefQmnum.close();t.onChangeRefQmnum(s)},cancel:()=>{this._SHRefQmnum.close()}});const o=new F({advancedMode:true,liveMode:false,search:this.onRefQmnumFilterSearch.bind(this),filterGroupItems:[new H({groupName:"__$INTERNAL$",name:"Qmnum",label:this.getText("Qmnum"),control:new _({submit:()=>this.onRefQmnumFilterSearch()})})]});this._SHRefQmnum.setFilterBar(o);const a=this._SHRefQmnum.getTable();a.setModel(s);a.bindRows("/ShRefQmnumSet",null,null,[]);["Qmnum","Qmtxt","Mawerk","Matnr","Revlv"].forEach(e=>{a.addColumn(new sap.ui.table.Column({label:new n({text:this.getText(e)}),template:new d({text:`{${e}}`})}))});this._SHRefQmnum.getTable().clearSelection();this._SHRefQmnum.update();this._SHRefQmnum.open()},onRefQmnumFilterSearch:function(){const e=this._SHRefQmnum.getFilterBar();const t=this._SHRefQmnum.getTable();const r=e.getFilterGroupItems().reduce((t,r)=>{const i=r.getName();const s=e.determineControlByFilterItem(r).getValue();if(s){t.push(new a(i,l.Contains,s));t.push(new a(i,l.Contains,s.toUpperCase()))}return t},[]);t.getBinding("rows")?.filter(r)},onVhSasi:function(e){const t=e.getSource();const r=this.getView();const i=r.getModel();this._SHSasi=new x({title:this.getText("ShSasiNoTitle"),supportMultiselect:false,resizable:true,key:"SasiNo",ok:e=>{let r=e.getParameter("tokens");t.setValue(r[0].getKey());t.setValueState("None");this._SHSasi.close()},cancel:()=>{this._SHSasi.close()}});const s=new F({advancedMode:true,liveMode:false,search:this.onSasiNoFilterSearch.bind(this),filterGroupItems:[new H({groupName:"__$INTERNAL$",name:"SasiNo",label:this.getText("SasiNo"),control:new _({submit:()=>this.onSasiNoFilterSearch()})})]});this._SHSasi.setFilterBar(s);const o=this._SHSasi.getTable();o.setModel(i);const g=this.getViewModel().getProperty("/Header");const u=[];if(g?.UrunGrubu){u.push(new a("UrunGrubu",l.EQ,g?.UrunGrubu||""))}if(g?.MtrEmission){u.push(new a("MtrEmission",l.EQ,g?.AracBolumu||""))}o.bindRows("/ShSasiSet",null,null,u);["SasiNo","GovdeNo"].forEach(e=>{o.addColumn(new sap.ui.table.Column({label:new n({text:this.getText(e)}),template:new d({text:`{${e}}`})}))});this._SHSasi.getTable().clearSelection();this._SHSasi.update();this._SHSasi.open()},onSasiNoFilterSearch:function(){const e=this._SHSasi.getFilterBar();const t=this._SHSasi.getTable();const r=e.getFilterGroupItems().reduce((t,r)=>{const i=r.getName();const s=e.determineControlByFilterItem(r).getValue();if(s){t.push(new a(i,l.Contains,s));t.push(new a(i,l.Contains,s.toUpperCase()))}return t},[]);t.getBinding("rows")?.filter(r)},onVhLifnr:function(e){const t=e.getSource();const r=this.getView();const i=r.getModel();this._SHLifnr=new x({title:this.getText("ShLifnrTitle"),supportMultiselect:false,resizable:true,key:"Lifnr",ok:e=>{let r=e.getParameter("tokens");t.setValue(r[0].getKey());let i=e.getParameter("tokens")[0].getAggregation("customData")[0].getProperty("value");this.getViewModel().setProperty("/Header/LfName1",i?.Mcod1);t.setValueState("None");this._SHLifnr.close()},cancel:()=>{this._SHLifnr.close()}});const s=new F({advancedMode:true,liveMode:false,search:this.onLifnrFilterSearch.bind(this),filterGroupItems:[new H({groupName:"__$INTERNAL$",name:"Lifnr",label:this.getText("Lifnr"),control:new _({submit:()=>this.onLifnrFilterSearch()})})]});this._SHLifnr.setFilterBar(s);const o=this._SHLifnr.getTable();o.setModel(i);o.bindRows("/ShLifnrSet",null,null);["Lifnr","Mcod1"].forEach(e=>{o.addColumn(new sap.ui.table.Column({label:new n({text:this.getText(e)}),template:new d({text:`{${e}}`})}))});this._SHLifnr.getTable().clearSelection();this._SHLifnr.update();this._SHLifnr.open()},onLifnrFilterSearch:function(){const e=this._SHLifnr.getFilterBar();const t=this._SHLifnr.getTable();const r=e.getFilterGroupItems().reduce((t,r)=>{const i=r.getName();const s=e.determineControlByFilterItem(r).getValue();if(s){t.push(new a(i,l.Contains,s));t.push(new a(i,l.Contains,s.toUpperCase()))}return t},[]);t.getBinding("rows")?.filter(r)},onVhMatnr:function(e){const r=e.getSource();const i=this.getView();const s=i.getModel();const o=this.getViewModel().getProperty("/Header");let g=[];let u=this.getViewModel().getProperty("/Header/Lifnr");if(!u){this.getViewModel().setProperty("/Header/Matnr","");this.getViewModel().setProperty("/Header/Maktx","");return t.error(this.getText("EnterFirstLifnr"))}this._SHMatnr=new x({title:this.getText("ShMatnrTitle"),supportMultiselect:false,resizable:true,key:"Matnr",ok:e=>{let t=e.getParameter("tokens");r.setValue(t[0].getKey());let i=e.getParameter("tokens")[0].getAggregation("customData")[0].getProperty("value");this.getViewModel().setProperty("/Header/Maktx",i?.Maktx);this.getViewModel().setProperty("/Header/PartStatu",i?.PartStatu);r.setValueState("None");this._SHMatnr.close()},cancel:()=>{this._SHMatnr.close()}});const p=new F({advancedMode:true,liveMode:false,search:this.onMatnrFilterSearch.bind(this),filterGroupItems:[new H({groupName:"__$INTERNAL$",name:"Matnr",label:this.getText("Matnr"),control:new _({submit:()=>this.onMatnrFilterSearch()})})]});this._SHMatnr.setFilterBar(p);const h=this._SHMatnr.getTable();h.setModel(s);if(o.Lifnr){g=[new a("Lifnr",l.EQ,o.Lifnr)]}h.bindRows("/ShMatnrSet",null,null,g);["Matnr","Maktx"].forEach(e=>{h.addColumn(new sap.ui.table.Column({label:new n({text:this.getText(e)}),template:new d({text:`{${e}}`})}))});this._SHMatnr.getTable().clearSelection();this._SHMatnr.update();this._SHMatnr.open()},onMatnrFilterSearch:function(){const e=this._SHMatnr.getFilterBar();const t=this._SHMatnr.getTable();const r=e.getFilterGroupItems().reduce((t,r)=>{const i=r.getName();const s=e.determineControlByFilterItem(r).getValue();if(s){t.push(new a(i,l.Contains,s));t.push(new a(i,l.Contains,s.toUpperCase()))}return t},[]);t.getBinding("rows")?.filter(r)},_getUserInformation:async function(){return new Promise((e,t)=>{if(window.top===window){e();return}s.show();this._readBtpWorkzoneId().then(r=>{const i=r.BtpWorkzoneID||r.BtpLinkID||r.BtpLink||"";let o;const n=async r=>{if(r.origin!==i)return;try{const t=JSON.parse(r.data);if(t?.RequestID==="UserMailRequest"&&t.UserMail){clearInterval(o);window.removeEventListener("message",n);await this._verifySupplierEmail(t.UserMail);s.hide();e()}}catch(e){clearInterval(o);window.removeEventListener("message",n);this._rejectInvalidUserAccess(n,o);t(e)}};window.addEventListener("message",n);o=setInterval(()=>{window.top.postMessage(JSON.stringify({RequestID:"UserMailRequest"}),i)},3e3)}).catch(e=>{s.hide();this._rejectInvalidUserAccess();t(e)})})},_readBtpWorkzoneId:function(e){const t=this.getOwnerComponent().getModel("btpService");return new Promise((e,r)=>{t.read(`/BtpLinkSet('OWN')`,{success:e,error:r})})},_verifySupplierEmail:async function(e){try{const t=await this._readUserByEmail(e);this.getView().getModel().setHeaders({email:e});return t}catch(e){this._rejectInvalidUserAccess();throw e}},_readUserByEmail:function(e){const t=this.getOwnerComponent().getModel("btpService");return new Promise((r,i)=>{t.read(`/SupplierLogonInfoSet('${e}')`,{success:r,error:i})})},_rejectInvalidUserAccess:function(e,r){s.hide();if(r)clearInterval(r);if(e)window.removeEventListener("message",e);let i=this.getView().getModel("i18n").getProperty("AuthSupplierNotFound");t.error(i,{actions:[t.Action.CLOSE],onClose:()=>{history.go(-1)}})}})});
//# sourceMappingURL=Notif.controller.js.map