sap.ui.define(["sap/ui/core/mvc/Controller","../model/formatter","sap/ui/core/BusyIndicator","sap/m/MessageBox","sap/ushell/Container"],function(e,t,n,r,o){"use strict";var i={};return e.extend("com.karsan.qm.sapmaportali.controller.Report",{formatter:t,onInit(){i=this.getOwnerComponent().getModel();i.setSizeLimit(1e6);const e=this.getOwnerComponent().getRouter();e.getRoute("Report").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(){this.getOwnerComponent().getModel().metadataLoaded().then(async()=>{await this._getUserInformation();let e=o.getUser().getId().toUpperCase();const t=i.createKey("/UserSet",{Uname:e});const n=await this.onRead(t,i);this.getViewModel().setProperty("/LoggedUser",n);await this.onInitFilter()})},onInitFilter:async function(e){let t=this.getViewModel().getProperty("/LoggedUser");let n=this.byId("idSfbReportSet").getControlByKey("Lifnr");if(t.IsSupplier){n.setValue(t.Uname);n.setEnabled(false)}},onSelectNotif(e){var t=e.getParameter("rowBindingContext").getObject().Qmnum;return this.getOwnerComponent().getRouter().navTo("Notif",{Qmnum:t})},onNewNotif(){return this.getOwnerComponent().getRouter().navTo("Notif",{Qmnum:"&1"})},_getUserInformation:async function(){return new Promise((e,t)=>{if(window.top===window){e();return}n.show();this._readBtpWorkzoneId().then(r=>{const o=r.BtpWorkzoneID||r.BtpLinkID||r.BtpLink||"";let i;const s=async r=>{if(r.origin!==o)return;try{const t=JSON.parse(r.data);if(t?.RequestID==="UserMailRequest"&&t.UserMail){clearInterval(i);window.removeEventListener("message",s);await this._verifySupplierEmail(t.UserMail);n.hide();e()}}catch(e){clearInterval(i);window.removeEventListener("message",s);this._rejectInvalidUserAccess(s,i);t(e)}};window.addEventListener("message",s);i=setInterval(()=>{window.top.postMessage(JSON.stringify({RequestID:"UserMailRequest"}),o)},3e3)}).catch(e=>{n.hide();this._rejectInvalidUserAccess();t(e)})})},_readBtpWorkzoneId:function(e){const t=this.getOwnerComponent().getModel("btpService");return new Promise((e,n)=>{t.read(`/BtpLinkSet('OWN')`,{success:e,error:n})})},_verifySupplierEmail:async function(e){try{const t=await this._readUserByEmail(e);this.getView().getModel().setHeaders({email:e});return t}catch(e){this._rejectInvalidUserAccess();throw e}},_readUserByEmail:function(e){const t=this.getOwnerComponent().getModel("btpService");return new Promise((n,r)=>{t.read(`/SupplierLogonInfoSet('${e}')`,{success:n,error:r})})},_rejectInvalidUserAccess:function(e,t){n.hide();if(t)clearInterval(t);if(e)window.removeEventListener("message",e);let o=this.getView().getModel("i18n").getProperty("AuthSupplierNotFound");r.error(o,{actions:[r.Action.CLOSE],onClose:()=>{history.go(-1)}})},getViewModel:function(){return this.getView().getModel("viewModel")},onRead(e,t){return new Promise((n,r)=>{const o={success:n,error:r};t.read(e,o)})}})});
//# sourceMappingURL=Report.controller.js.map